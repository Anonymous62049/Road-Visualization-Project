<!DOCTYPE html>
<html>
<head>
    <title>City Road Network</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map" style="width: 90vw; height: 800px;"></div>
    <div style="width: 100px; height: 50px; background-color: wheat;display: inline-block;" onclick="showNextRoad([],nodes[4567].geometry.coordinates.toString());"></div>
    <label id="debugLbl" style="display: inline;"></label>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var map = L.map('map').setView([-33.9130293,151.2], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,
        }).addTo(map);
        var nextRoads = [];
        var edges;
        const edgeMap = new Map();
        var nodes;
        $.getJSON('nodes.json', function(data){
            nodes = data.features;
            endNode = nodes[8765]; //12334
        })
        // Load the edges JSON data
        $.getJSON('edges.json', function(data) {
            edges = data.features;
            loadEdgeMap();
        });
        var endNode;
        var visited = new Map();
        var nodeDistance = new Map();
        var found = false;
        var drawn = false;
        function showNextRoad(path, coords, pathLength = 0){
            var node = nodeDistance.get(coords);
            if(coords == endNode.geometry.coordinates) found = true;
            //if(coords == endNode.geometry.coordinates && node) document.getElementById("debugLbl").innerHTML += node[1] + ", " + pathLength + " : ";
            if(!node || node[1] > pathLength){
                nodeDistance.set(coords, [[...path], pathLength]);
            }
            else if(node && node[1] < pathLength){
                path = node[0];
                pathLength = node[1];
            }
            edgeMap.get(coords).forEach((road) => {
                i = 0; //Keep
                if(!visited.get(road.id)){
                    visited.set(road.id, true);
                    nextRoads.push(road);
                    var roadCoords = road.geometry.coordinates;
                    var newCoords = roadCoords[roadCoords.length - 1][0] + "," + roadCoords[roadCoords.length - 1][1];
                    var newPath = [...path, road];
                    requestAnimationFrame(function(){showNextRoad(newPath, newCoords, pathLength + road.properties.length)});
                    i++;
                }
            })
            requestAnimationFrame(function(){showRoad(i,'blue', nextRoads)});
            if(nodeDistance.size + 100 >= nodes.length && found && !drawn){
                var shortestPath = nodeDistance.get(endNode.geometry.coordinates.toString());
                requestAnimationFrame(function(){showRoad(shortestPath[1], 'red', shortestPath[0], 3)});
                drawn = true;
            }
        }
        function showRoad(roadNum, color, arr, thickness = 1){
            for(let i = 0; i <= roadNum; i++){
                var road = arr.pop();
                L.geoJSON(road, {
                    style: {color: color, weight:  thickness}
                }).addTo(map);
            }
        }
        function loadEdgeMap(){
            for(let i = 0; i < edges.length; i++){
                var coords = edges[i].geometry.coordinates;
                var prev = edgeMap.get(coords[0][0] + "," + coords[0][1]);
                if(prev) prev.push(edges[i]);
                edgeMap.set(coords[0][0] + "," + coords[0][1], prev ? prev.sort(function(a,b){a.properties.length - b.properties.length}) : [edges[i]].sort(function(a,b){a.properties.length - b.properties.length}));
                prev = edgeMap.get(coords[coords.length - 1][0] + "," + coords[coords.length - 1][1]);
                if(prev) prev.push(edges[i]);
                edgeMap.set(coords[coords.length - 1][0] + "," + coords[coords.length - 1][1], prev ? prev.sort(function(a,b){a.properties.length - b.properties.length}) : [edges[i]].sort(function(a,b){a.properties.length - b.properties.length}));
            }
        }
    </script>
</body>
</html>
